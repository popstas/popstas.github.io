<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Zle on Popstas</title>
    <link>http://blog.popstas.ru/tags/zle/index.xml</link>
    <description>Recent content in Zle on Popstas</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ru-ru</language>
    <atom:link href="http://blog.popstas.ru/tags/zle/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Продублировать последний аргумент текущей команды в zsh, zle widget</title>
      <link>http://blog.popstas.ru/blog/2017/03/18/zsh-duplicate-last-argument-in-current-command/</link>
      <pubDate>Sat, 18 Mar 2017 22:20:28 +0000</pubDate>
      
      <guid>http://blog.popstas.ru/blog/2017/03/18/zsh-duplicate-last-argument-in-current-command/</guid>
      <description>&lt;p&gt;В последнее время я упоролся по тюнингу своего zsh. Потратил на это кучу времени, но есть и плюсы:
поучаствовав в правке пары плагинов, я начал понимать, как работает вся эта магия, которой я давно пользуюсь.&lt;/p&gt;

&lt;p&gt;Так вот, у меня в терминале бывает частая задача: скопировать файл и положить рядом с немного другим именем.
Раньше я пользовался такой схемой:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ls filename.ext
cp &amp;lt;Alt+.&amp;gt; &amp;lt;Alt+.&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;То есть, я сначала вводил команду-пустышку, такую, чтобы в историю попала команда, где последним аргументом будет путь к файлу.
Потом через &lt;code&gt;Alt+.&lt;/code&gt; вставлял 2 раза последний аргумент предыдущей команды.&lt;/p&gt;

&lt;p&gt;Другие примеры использования:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mv path/file1 path/file2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cp config.example config&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mc /home/user /home/user&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Теперь я могу делать так:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cp filename.ext &amp;lt;Alt+,&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;В действии:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://blog.popstas.ru/images/2017-03/zsh-duplicate-last-arg.gif&#34; /&gt;
&lt;/p&gt;

&lt;p&gt;Когда я правил чужие виджеты (виджетом в zsh называется функция, повешенная на хоткей), я понял,
что у zsh большие возможности по редактированию текущей строки комманд. Оставалось узнать, как это нагуглить.&lt;/p&gt;

&lt;p&gt;Ключевик я нашел в тех же скриптах: &lt;code&gt;ZLE&lt;/code&gt; или Zsh Line Editor. ОК, гуглим &lt;code&gt;zsh zle&lt;/code&gt;,
попадаем &lt;a href=&#34;http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html&#34; target=&#34;_blank&#34;&gt;на доку&lt;/a&gt;. Через 10 минут чтения и правок родилась эта функция.&lt;/p&gt;

&lt;p&gt;После того, как я написал свой виджет, оказалось, что такая команда уже встроена в zsh, и даже лучше.
Оставлю свой скрипт в конце статьи для того, чтобы было понятно, как можно писать свои виджеты, но пользоваться лучше этим:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #002B36&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #586E75&#34;&gt;# Example &amp;lt;Ctrl+.&amp;gt;&amp;lt;Ctrl+,&amp;gt; inserts 2nd argument from end of prev. cmd&lt;/span&gt;
&lt;span style=&#34;color: #586E75&#34;&gt;# http://chneukirchen.org/blog/archive/2013/03/10-fresh-zsh-tricks-you-may-not-know.html&lt;/span&gt;
autoload -Uz copy-earlier-word
zle -N copy-earlier-word
bindkey &lt;span style=&#34;color: #2AA198&#34;&gt;&amp;quot;^[,&amp;quot;&lt;/span&gt; copy-earlier-word
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Код надо вставить в &lt;code&gt;.zshrc&lt;/code&gt; или &lt;code&gt;.zshrc.local&lt;/code&gt; если вы пользуетесь
&lt;a href=&#34;http://blog.popstas.ru/blog/2017/03/09/ansible-role-zsh-powerlevel9k-fzf-syntax-autosuggestions/&#34; target=&#34;_blank&#34;&gt;ansible-role-zsh&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Виджет вставляет последний аргумент текущей команды, но если нажать еще дважды - вставит предпоследний.
Например, вы ввели команду &lt;code&gt;some-command arg1 arg2&lt;/code&gt;, чтобы вставить предпоследний аргумент, нажмите &lt;code&gt;&amp;lt;Alt+.&amp;gt;&amp;lt;Alt+,&amp;gt;&amp;lt;Alt+,&amp;gt;&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&#34;как-работают-виджеты-zsh&#34;&gt;Как работают виджеты zsh:&lt;/h3&gt;

&lt;p&gt;Функция, вызванная через механизм виджетов, имеет доступ к куче внутренних переменных zsh, некоторые можно только читать,
другие можно изменять на лету.&lt;/p&gt;

&lt;p&gt;Я воспользовался двумя переменными:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;BUFFER&lt;/code&gt; - содержит текущую введенную команду. Переменную можно менять, но курсор при этом остается на месте.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;CURSOR&lt;/code&gt; - позиция курсора&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Оставалось сделать команде rtrim, отрезать последнее слово, добавить к буферу и передвинуть курсор на новое место.&lt;/p&gt;

&lt;p&gt;Сам скрипт:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #002B36&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #586E75&#34;&gt;# Ctrl+, - duplicate last word in current command&lt;/span&gt;
zsh-duplicate-last-arg&lt;span style=&#34;color: #719e07&#34;&gt;()&lt;/span&gt; &lt;span style=&#34;color: #719e07&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #268BD2&#34;&gt;BUFFER&lt;/span&gt;&lt;span style=&#34;color: #719e07&#34;&gt;=$(&lt;/span&gt;&lt;span style=&#34;color: #B58900&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #2AA198&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #268BD2&#34;&gt;$BUFFER&lt;/span&gt;&lt;span style=&#34;color: #2AA198&#34;&gt;&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #93A1A1&#34;&gt;|&lt;/span&gt; sed -e &lt;span style=&#34;color: #2AA198&#34;&gt;&amp;#39;s/[[:space:]]*$//&amp;#39;&lt;/span&gt;&lt;span style=&#34;color: #719e07&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color: #268BD2&#34;&gt;BUFFER&lt;/span&gt;&lt;span style=&#34;color: #719e07&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #2AA198&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #268BD2&#34;&gt;$BUFFER&lt;/span&gt;&lt;span style=&#34;color: #2AA198&#34;&gt; ${&lt;/span&gt;&lt;span style=&#34;color: #268BD2&#34;&gt;BUFFER&lt;/span&gt;&lt;span style=&#34;color: #93A1A1&#34;&gt;##* &lt;/span&gt;&lt;span style=&#34;color: #2AA198&#34;&gt;}&amp;quot;&lt;/span&gt;
	&lt;span style=&#34;color: #268BD2&#34;&gt;CURSOR&lt;/span&gt;&lt;span style=&#34;color: #719e07&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #268BD2&#34;&gt;$#&lt;/span&gt;BUFFER
&lt;span style=&#34;color: #719e07&#34;&gt;}&lt;/span&gt;
zle -N zsh-duplicate-last-arg
bindkey &lt;span style=&#34;color: #2AA198&#34;&gt;&amp;#39;^[,&amp;#39;&lt;/span&gt; zsh-duplicate-last-arg
&lt;/pre&gt;&lt;/div&gt;</description>
    </item>
    
  </channel>
</rss>